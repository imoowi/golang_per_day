/*
generated by comer,https://github.com/imoowi/comer
Copyright © 2023 jun<simpleyuan@gmail.com>
*/
package controllers

import (
	"net/http"

	"user-service/internal/global"
	"user-service/internal/models"
	"user-service/internal/services"

	"github.com/gin-gonic/gin"
	"github.com/gin-gonic/gin/binding"
	"github.com/imoowi/comer/utils/response"
)

// @Summary	登录
// @Tags		Auth
// @Accept		application/json
// @Produce	application/json
// @Param {object} body  models.UserLogin true "登录信息"
// @Success	200
// @Failure	400	{object}	string	"请求错误"
// @Failure	401	{object}	string	"token验证失败"
// @Failure	500	{object}	string	"内部错误"
// @Router		/api/user/auth-login [post]
func AuthLogin(c *gin.Context) {
	var userLogin *models.UserLogin
	err := c.ShouldBindBodyWith(&userLogin, binding.JSON)
	if err != nil {
		response.Error(c, err.Error(), http.StatusBadRequest)
		return
	}
	user, err := services.User.Login(c, userLogin)
	if err != nil {
		response.Error(c, err.Error(), http.StatusBadRequest)
		return
	}
	if user == nil || user.ID <= 0 {
		response.Error(c, `record not found`, http.StatusBadRequest)
		return
	}
	// // 生成Token
	// tokenString, _ := token.GenToken(user.Username, user.ID)
	// response.OK(c, gin.H{"token": tokenString})
	tokenStr, _ := global.JwtGenerator.GenerateToken(user.GetID())
	// apisixJwt := apisix.NewImoowiApisix()
	// apisixJwt.CreateConsumer(cast.ToString(user.GetID()))
	// apisixJwt.CreateConsumerCredentials(cast.ToString(user.GetID()), `abc`, `def`)
	response.OK(c, gin.H{"token": tokenStr})
}

// @Summary	退出
// @Tags		Auth
// @Accept		application/json
// @Produce	application/json
// @Param		Authorization	header	string	true	"Bearer 用户令牌"
// @Success	200
// @Failure	400	{object}	string	"请求错误"
// @Failure	401	{object}	string	"token验证失败"
// @Failure	500	{object}	string	"内部错误"
// @Router		/api/user/auth-logout [get]
func AuthLogout(c *gin.Context) {
	authHeader := c.Request.Header.Get("Authorization")
	if authHeader == "" {
		response.Error(c, `请求头中auth为空`, http.StatusUnauthorized)
		return
	}
	ok := services.User.Logout(c, authHeader)
	response.OK(c, ok)
}

// @Summary	改密
// @Tags		Auth
// @Accept		application/json
// @Produce	application/json
// @Param		Authorization	header	string				true	"Bearer 用户令牌"
// @Param {object} body  models.UserChgPwd true "改密信息"
// @Success	200
// @Failure	400	{object}	string	"请求错误"
// @Failure	401	{object}	string	"token验证失败"
// @Failure	500	{object}	string	"内部错误"
// @Router		/api/user/auth-chpwd [post]
func AuthChgPwd(c *gin.Context) {
	var userChgPwd *models.UserChgPwd
	err := c.ShouldBindBodyWith(&userChgPwd, binding.JSON)
	if err != nil {
		response.Error(c, err.Error(), http.StatusBadRequest)
		return
	}
	newJwtToken, err := services.User.ChgPwd(c, userChgPwd)
	if err != nil {
		response.Error(c, err.Error(), http.StatusBadRequest)
		return
	}
	if newJwtToken != `` {
		c.Header(`token`, newJwtToken)
	}
	response.OK(c, newJwtToken)
}

// @Summary	获取用户信息
// @Tags		Auth
// @Accept		application/json
// @Produce	application/json
// @Param		Authorization	header	string	true	"Bearer 用户令牌"
// @Success	200
// @Failure	400	{object}	string	"请求错误"
// @Failure	401	{object}	string	"token验证失败"
// @Failure	500	{object}	string	"内部错误"
// @Router		/api/user/auth-info [get]
func AuthInfo(c *gin.Context) {
	user, err := services.User.Info(c)
	if err != nil {
		response.Error(c, err.Error(), http.StatusBadRequest)
		return
	}
	response.OK(c, user)
}
